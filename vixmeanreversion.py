import pandas as pd
import numpy as np
import datetime
from datetime import timezone as dt_timezone
import logging

class VIXReversionStrategy:
    """
    Live implementation of the VIX Mean Reversion Strategy.
    Contains 557 hardcoded micro-segments derived from historical optimization.
    """
    def __init__(self):
        self.strategy_name = "VIXMeanReversion"
        # Dictionary Key Format: (Quarter, Month, Week, DayOfWeek, SessionID)
        # Value: Z_Score to use for Bollinger Bands
        self.micro_segments = {
            (1, 1, 1, 0, 0): 1.5, (1, 1, 1, 0, 2): 2.0, (1, 1, 1, 1, 0): 1.5, (1, 1, 1, 4, 1): 2.5,
            (1, 1, 1, 4, 3): 1.5, (1, 1, 2, 0, 0): 2.0, (1, 1, 2, 0, 1): 2.0, (1, 1, 2, 0, 3): 1.5,
            (1, 1, 2, 1, 1): 1.5, (1, 1, 2, 2, 0): 1.5, (1, 1, 2, 2, 1): 2.5, (1, 1, 2, 2, 2): 1.5,
            (1, 1, 2, 2, 3): 1.5, (1, 1, 2, 4, 1): 1.5, (1, 1, 2, 4, 2): 2.0, (1, 1, 2, 4, 3): 2.0,
            (1, 1, 3, 0, 0): 1.5, (1, 1, 3, 1, 1): 2.0, (1, 1, 3, 1, 3): 1.5, (1, 1, 3, 2, 0): 2.5,
            (1, 1, 3, 2, 3): 1.5, (1, 1, 3, 3, 0): 2.5, (1, 1, 3, 3, 3): 1.5, (1, 1, 3, 4, 0): 1.5,
            (1, 1, 3, 4, 2): 2.0, (1, 1, 3, 4, 3): 1.5, (1, 1, 4, 0, 1): 2.0, (1, 1, 4, 1, 0): 2.5,
            (1, 1, 4, 1, 1): 1.5, (1, 1, 4, 1, 2): 2.5, (1, 1, 4, 1, 3): 1.5, (1, 1, 4, 2, 3): 1.5,
            (1, 1, 4, 3, 0): 2.0, (1, 1, 4, 3, 1): 2.5, (1, 1, 4, 3, 2): 1.5, (1, 1, 4, 3, 3): 1.5,
            (1, 1, 4, 4, 2): 2.0, (1, 1, 5, 0, 2): 2.0, (1, 1, 5, 1, 0): 1.5, (1, 1, 5, 1, 1): 2.5,
            (1, 1, 5, 2, 3): 2.0, (1, 1, 5, 3, 0): 1.5, (1, 1, 5, 4, 2): 1.5, (1, 2, 1, 0, 1): 1.5,
            (1, 2, 1, 0, 3): 1.5, (1, 2, 1, 1, 3): 2.0, (1, 2, 1, 2, 0): 2.0, (1, 2, 1, 2, 1): 2.5,
            (1, 2, 1, 2, 3): 1.5, (1, 2, 1, 3, 1): 2.5, (1, 2, 1, 3, 2): 2.5, (1, 2, 1, 4, 3): 1.5,
            (1, 2, 2, 0, 0): 1.5, (1, 2, 2, 0, 3): 1.5, (1, 2, 2, 1, 3): 1.5, (1, 2, 2, 2, 1): 1.5,
            (1, 2, 2, 2, 3): 2.0, (1, 2, 2, 3, 1): 1.5, (1, 2, 2, 3, 3): 1.5, (1, 2, 2, 4, 1): 2.0,
            (1, 2, 2, 4, 3): 1.5, (1, 2, 3, 0, 0): 1.5, (1, 2, 3, 1, 2): 1.5, (1, 2, 3, 1, 3): 1.5,
            (1, 2, 3, 2, 0): 1.5, (1, 2, 3, 2, 2): 1.5, (1, 2, 3, 2, 3): 1.5, (1, 2, 3, 3, 0): 2.0,
            (1, 2, 3, 3, 1): 2.0, (1, 2, 3, 3, 3): 2.0, (1, 2, 3, 4, 3): 1.5, (1, 2, 4, 0, 0): 2.5,
            (1, 2, 4, 0, 1): 1.5, (1, 2, 4, 0, 3): 1.5, (1, 2, 4, 1, 0): 2.5, (1, 2, 4, 1, 1): 2.0,
            (1, 2, 4, 1, 3): 1.5, (1, 2, 4, 2, 0): 1.5, (1, 2, 4, 2, 1): 2.5, (1, 2, 4, 2, 3): 2.0,
            (1, 2, 4, 3, 1): 1.5, (1, 2, 4, 4, 0): 2.0, (1, 2, 4, 4, 2): 2.0, (1, 2, 4, 4, 3): 1.5,
            (1, 2, 5, 3, 1): 1.5, (1, 2, 5, 3, 2): 2.0, (1, 3, 1, 0, 2): 2.5, (1, 3, 1, 0, 3): 1.5,
            (1, 3, 1, 1, 0): 2.5, (1, 3, 1, 1, 3): 1.5, (1, 3, 1, 2, 3): 1.5, (1, 3, 1, 3, 0): 2.0,
            (1, 3, 1, 3, 1): 2.0, (1, 3, 1, 3, 2): 2.0, (1, 3, 1, 3, 3): 1.5, (1, 3, 1, 4, 1): 2.5,
            (1, 3, 1, 4, 3): 1.5, (1, 3, 2, 0, 0): 1.5, (1, 3, 2, 0, 3): 1.5, (1, 3, 2, 1, 0): 2.5,
            (1, 3, 2, 1, 2): 1.5, (1, 3, 2, 1, 3): 1.5, (1, 3, 2, 2, 1): 2.0, (1, 3, 2, 2, 3): 1.5,
            (1, 3, 2, 3, 0): 2.5, (1, 3, 2, 3, 3): 1.5, (1, 3, 2, 4, 2): 1.5, (1, 3, 3, 0, 1): 2.0,
            (1, 3, 3, 0, 3): 2.0, (1, 3, 3, 1, 0): 1.5, (1, 3, 3, 1, 1): 2.5, (1, 3, 3, 1, 2): 2.5,
            (1, 3, 3, 1, 3): 1.5, (1, 3, 3, 2, 1): 2.0, (1, 3, 3, 2, 2): 1.5, (1, 3, 3, 3, 0): 2.5,
            (1, 3, 3, 3, 3): 1.5, (1, 3, 3, 4, 0): 2.5, (1, 3, 3, 4, 1): 1.5, (1, 3, 3, 4, 3): 1.5,
            (1, 3, 4, 0, 0): 1.5, (1, 3, 4, 0, 1): 2.0, (1, 3, 4, 0, 3): 1.5, (1, 3, 4, 1, 0): 2.5,
            (1, 3, 4, 1, 2): 1.5, (1, 3, 4, 2, 3): 2.0, (1, 3, 4, 3, 3): 1.5, (1, 3, 4, 4, 1): 2.0,
            (1, 3, 5, 0, 1): 2.0, (1, 3, 5, 0, 2): 2.0, (1, 3, 5, 2, 0): 2.0, (1, 3, 5, 2, 1): 1.5,
            (1, 3, 5, 4, 2): 2.0, (2, 4, 1, 0, 1): 2.5, (2, 4, 1, 0, 2): 1.5, (2, 4, 1, 1, 1): 1.5,
            (2, 4, 1, 1, 2): 2.5, (2, 4, 1, 1, 3): 1.5, (2, 4, 1, 2, 0): 2.5, (2, 4, 1, 2, 1): 2.5,
            (2, 4, 1, 2, 3): 1.5, (2, 4, 1, 3, 0): 2.0, (2, 4, 2, 0, 1): 2.5, (2, 4, 2, 0, 2): 2.0,
            (2, 4, 2, 1, 1): 2.0, (2, 4, 2, 1, 3): 1.5, (2, 4, 2, 2, 1): 2.5, (2, 4, 2, 2, 3): 1.5,
            (2, 4, 2, 3, 1): 2.0, (2, 4, 2, 3, 2): 2.0, (2, 4, 2, 4, 1): 2.5, (2, 4, 3, 0, 2): 2.0,
            (2, 4, 3, 0, 3): 1.5, (2, 4, 3, 1, 0): 2.0, (2, 4, 3, 1, 2): 2.5, (2, 4, 3, 1, 3): 1.5,
            (2, 4, 3, 2, 2): 2.5, (2, 4, 3, 3, 1): 2.5, (2, 4, 3, 3, 3): 1.5, (2, 4, 4, 0, 0): 2.5,
            (2, 4, 4, 0, 1): 2.0, (2, 4, 4, 0, 2): 2.0, (2, 4, 4, 0, 3): 2.0, (2, 4, 4, 1, 0): 1.5,
            (2, 4, 4, 1, 3): 1.5, (2, 4, 4, 2, 2): 2.5, (2, 4, 4, 3, 1): 2.0, (2, 4, 4, 3, 2): 2.5,
            (2, 4, 4, 3, 3): 1.5, (2, 4, 4, 4, 0): 1.5, (2, 4, 4, 4, 1): 2.5, (2, 4, 4, 4, 3): 2.0,
            (2, 4, 5, 0, 2): 1.5, (2, 4, 5, 1, 3): 2.0, (2, 4, 5, 2, 0): 1.5, (2, 4, 5, 2, 2): 1.5,
            (2, 5, 1, 0, 3): 1.5, (2, 5, 1, 1, 1): 2.0, (2, 5, 1, 1, 2): 2.0, (2, 5, 1, 1, 3): 2.0,
            (2, 5, 1, 2, 1): 2.5, (2, 5, 1, 2, 2): 2.5, (2, 5, 1, 3, 1): 2.5, (2, 5, 1, 3, 2): 2.5,
            (2, 5, 1, 3, 3): 1.5, (2, 5, 1, 4, 1): 2.5, (2, 5, 1, 4, 2): 1.5, (2, 5, 1, 4, 3): 2.0,
            (2, 5, 2, 0, 2): 2.5, (2, 5, 2, 1, 0): 2.5, (2, 5, 2, 1, 1): 2.0, (2, 5, 2, 1, 3): 1.5,
            (2, 5, 2, 2, 0): 2.5, (2, 5, 2, 2, 2): 2.5, (2, 5, 2, 2, 3): 1.5, (2, 5, 2, 3, 0): 2.5,
            (2, 5, 2, 3, 3): 1.5, (2, 5, 2, 4, 0): 2.5, (2, 5, 2, 4, 1): 2.5, (2, 5, 2, 4, 2): 2.0,
            (2, 5, 2, 4, 3): 1.5, (2, 5, 3, 0, 0): 2.0, (2, 5, 3, 0, 1): 1.5, (2, 5, 3, 0, 2): 2.0,
            (2, 5, 3, 0, 3): 2.0, (2, 5, 3, 1, 0): 2.5, (2, 5, 3, 1, 3): 1.5, (2, 5, 3, 2, 0): 2.0,
            (2, 5, 3, 2, 1): 2.5, (2, 5, 3, 2, 2): 2.5, (2, 5, 3, 2, 3): 1.5, (2, 5, 3, 3, 0): 2.0,
            (2, 5, 3, 3, 1): 2.5, (2, 5, 3, 3, 2): 2.5, (2, 5, 3, 3, 3): 1.5, (2, 5, 3, 4, 3): 1.5,
            (2, 5, 4, 1, 0): 1.5, (2, 5, 4, 2, 0): 2.0, (2, 5, 4, 3, 0): 2.0, (2, 5, 4, 3, 3): 1.5,
            (2, 5, 4, 4, 1): 1.5, (2, 5, 4, 4, 2): 2.5, (2, 5, 4, 4, 3): 1.5, (2, 5, 5, 2, 1): 2.0,
            (2, 5, 5, 2, 2): 2.5, (2, 5, 5, 3, 1): 2.0, (2, 5, 5, 3, 3): 1.5, (2, 5, 5, 4, 2): 1.5,
            (2, 5, 5, 4, 3): 1.5, (2, 6, 1, 0, 3): 1.5, (2, 6, 1, 1, 0): 2.0, (2, 6, 1, 1, 1): 2.0,
            (2, 6, 1, 1, 2): 2.5, (2, 6, 1, 1, 3): 1.5, (2, 6, 1, 2, 1): 2.0, (2, 6, 1, 2, 3): 1.5,
            (2, 6, 1, 4, 0): 2.0, (2, 6, 1, 4, 1): 2.5, (2, 6, 1, 4, 3): 1.5, (2, 6, 2, 0, 0): 2.0,
            (2, 6, 2, 0, 1): 2.0, (2, 6, 2, 0, 3): 1.5, (2, 6, 2, 1, 0): 2.5, (2, 6, 2, 1, 1): 1.5,
            (2, 6, 2, 1, 2): 2.0, (2, 6, 2, 1, 3): 1.5, (2, 6, 2, 2, 3): 1.5, (2, 6, 2, 3, 0): 1.5,
            (2, 6, 2, 3, 1): 1.5, (2, 6, 2, 3, 2): 2.5, (2, 6, 2, 3, 3): 1.5, (2, 6, 2, 4, 3): 1.5,
            (2, 6, 3, 0, 0): 2.0, (2, 6, 3, 0, 1): 1.5, (2, 6, 3, 0, 3): 1.5, (2, 6, 3, 1, 2): 2.0,
            (2, 6, 3, 1, 3): 1.5, (2, 6, 3, 2, 0): 2.0, (2, 6, 3, 2, 3): 1.5, (2, 6, 3, 3, 0): 2.0,
            (2, 6, 3, 3, 2): 2.5, (2, 6, 3, 3, 3): 1.5, (2, 6, 3, 4, 0): 2.0, (2, 6, 3, 4, 1): 2.5,
            (2, 6, 3, 4, 2): 2.5, (2, 6, 3, 4, 3): 1.5, (2, 6, 4, 0, 3): 1.5, (2, 6, 4, 1, 0): 1.5,
            (2, 6, 4, 1, 1): 2.0, (2, 6, 4, 1, 2): 2.0, (2, 6, 4, 1, 3): 1.5, (2, 6, 4, 2, 1): 2.5,
            (2, 6, 4, 2, 2): 1.5, (2, 6, 4, 2, 3): 1.5, (2, 6, 4, 3, 0): 1.5, (2, 6, 4, 3, 1): 2.0,
            (2, 6, 4, 3, 2): 2.0, (2, 6, 4, 3, 3): 1.5, (2, 6, 4, 4, 0): 2.0, (2, 6, 4, 4, 3): 2.0,
            (2, 6, 5, 0, 0): 1.5, (2, 6, 5, 3, 0): 1.5, (2, 6, 5, 3, 2): 2.5, (2, 6, 5, 4, 1): 1.5,
            (3, 7, 1, 0, 1): 2.5, (3, 7, 1, 0, 2): 2.0, (3, 7, 1, 1, 1): 2.0, (3, 7, 1, 1, 2): 2.5,
            (3, 7, 1, 1, 3): 1.5, (3, 7, 1, 2, 0): 1.5, (3, 7, 1, 2, 1): 2.0, (3, 7, 1, 2, 3): 1.5,
            (3, 7, 1, 3, 0): 2.0, (3, 7, 1, 3, 1): 2.0, (3, 7, 1, 3, 2): 1.5, (3, 7, 1, 4, 0): 2.5,
            (3, 7, 1, 4, 1): 1.5, (3, 7, 1, 4, 3): 1.5, (3, 7, 2, 0, 1): 1.5, (3, 7, 2, 0, 2): 2.0,
            (3, 7, 2, 0, 3): 1.5, (3, 7, 2, 1, 0): 2.0, (3, 7, 2, 1, 1): 2.0, (3, 7, 2, 1, 2): 2.0,
            (3, 7, 2, 1, 3): 1.5, (3, 7, 2, 2, 1): 2.5, (3, 7, 2, 2, 2): 1.5, (3, 7, 2, 2, 3): 1.5,
            (3, 7, 2, 3, 0): 2.5, (3, 7, 2, 3, 1): 1.5, (3, 7, 2, 3, 2): 2.5, (3, 7, 2, 3, 3): 1.5,
            (3, 7, 2, 4, 1): 1.5, (3, 7, 2, 4, 2): 2.5, (3, 7, 2, 4, 3): 2.5, (3, 7, 3, 0, 0): 2.5,
            (3, 7, 3, 0, 3): 1.5, (3, 7, 3, 1, 0): 2.5, (3, 7, 3, 1, 1): 2.5, (3, 7, 3, 2, 1): 2.0,
            (3, 7, 3, 2, 2): 2.0, (3, 7, 3, 2, 3): 1.5, (3, 7, 3, 3, 3): 1.5, (3, 7, 3, 4, 3): 1.5,
            (3, 7, 4, 0, 0): 2.0, (3, 7, 4, 0, 2): 2.0, (3, 7, 4, 0, 3): 2.0, (3, 7, 4, 1, 0): 2.5,
            (3, 7, 4, 2, 1): 1.5, (3, 7, 4, 3, 3): 1.5, (3, 7, 4, 4, 0): 2.5, (3, 7, 4, 4, 1): 2.0,
            (3, 7, 4, 4, 3): 1.5, (3, 7, 5, 0, 1): 2.0, (3, 7, 5, 1, 2): 2.5, (3, 8, 1, 0, 0): 2.0,
            (3, 8, 1, 0, 2): 1.5, (3, 8, 1, 1, 1): 1.5, (3, 8, 1, 1, 3): 1.5, (3, 8, 1, 2, 0): 2.5,
            (3, 8, 1, 2, 3): 1.5, (3, 8, 1, 3, 2): 2.5, (3, 8, 1, 4, 0): 2.0, (3, 8, 2, 0, 0): 1.5,
            (3, 8, 2, 0, 3): 1.5, (3, 8, 2, 1, 0): 2.0, (3, 8, 2, 1, 1): 2.0, (3, 8, 2, 1, 2): 1.5,
            (3, 8, 2, 2, 1): 2.0, (3, 8, 2, 2, 3): 1.5, (3, 8, 2, 3, 2): 2.5, (3, 8, 2, 4, 3): 1.5,
            (3, 8, 3, 0, 1): 2.0, (3, 8, 3, 0, 2): 2.0, (3, 8, 3, 0, 3): 1.5, (3, 8, 3, 1, 3): 1.5,
            (3, 8, 3, 2, 3): 1.5, (3, 8, 3, 3, 0): 2.0, (3, 8, 3, 4, 1): 2.0, (3, 8, 3, 4, 3): 2.0,
            (3, 8, 4, 0, 3): 1.5, (3, 8, 4, 1, 0): 1.5, (3, 8, 4, 1, 2): 1.5, (3, 8, 4, 1, 3): 1.5,
            (3, 8, 4, 2, 3): 1.5, (3, 8, 4, 3, 1): 2.5, (3, 8, 4, 3, 3): 1.5, (3, 8, 4, 4, 1): 2.0,
            (3, 8, 4, 4, 3): 2.0, (3, 8, 5, 1, 0): 1.5, (3, 8, 5, 3, 0): 1.5, (3, 8, 5, 3, 1): 2.0,
            (3, 8, 5, 4, 2): 1.5, (3, 9, 1, 0, 0): 2.5, (3, 9, 1, 1, 1): 1.5, (3, 9, 1, 1, 3): 2.0,
            (3, 9, 1, 2, 0): 2.5, (3, 9, 1, 2, 2): 2.5, (3, 9, 1, 3, 0): 2.0, (3, 9, 1, 3, 1): 1.5,
            (3, 9, 1, 3, 2): 1.5, (3, 9, 1, 3, 3): 1.5, (3, 9, 1, 4, 2): 2.5, (3, 9, 2, 0, 0): 1.5,
            (3, 9, 2, 0, 2): 2.5, (3, 9, 2, 0, 3): 1.5, (3, 9, 2, 1, 1): 2.0, (3, 9, 2, 1, 3): 1.5,
            (3, 9, 2, 2, 3): 1.5, (3, 9, 2, 3, 1): 1.5, (3, 9, 2, 3, 2): 2.5, (3, 9, 2, 4, 1): 2.5,
            (3, 9, 3, 0, 0): 2.0, (3, 9, 3, 0, 1): 2.0, (3, 9, 3, 0, 3): 1.5, (3, 9, 3, 1, 0): 2.0,
            (3, 9, 3, 1, 2): 2.0, (3, 9, 3, 1, 3): 1.5, (3, 9, 3, 2, 1): 2.0, (3, 9, 3, 2, 2): 2.5,
            (3, 9, 3, 2, 3): 1.5, (3, 9, 3, 3, 1): 2.5, (3, 9, 3, 3, 3): 1.5, (3, 9, 3, 4, 0): 2.5,
            (3, 9, 3, 4, 2): 2.5, (3, 9, 3, 4, 3): 1.5, (3, 9, 4, 0, 1): 1.5, (3, 9, 4, 0, 2): 1.5,
            (3, 9, 4, 0, 3): 1.5, (3, 9, 4, 2, 3): 1.5, (3, 9, 4, 3, 0): 1.5, (3, 9, 4, 3, 1): 2.5,
            (3, 9, 4, 3, 2): 2.5, (3, 9, 4, 3, 3): 1.5, (3, 9, 4, 4, 0): 2.0, (3, 9, 4, 4, 3): 1.5,
            (3, 9, 5, 1, 0): 1.5, (3, 9, 5, 1, 1): 2.0, (3, 9, 5, 1, 2): 1.5, (3, 9, 5, 4, 0): 2.0,
            (4, 10, 1, 1, 1): 2.5, (4, 10, 1, 1, 2): 2.5, (4, 10, 1, 1, 3): 1.5, (4, 10, 1, 2, 0): 1.5,
            (4, 10, 1, 2, 2): 2.0, (4, 10, 1, 2, 3): 1.5, (4, 10, 1, 3, 0): 1.5, (4, 10, 1, 3, 1): 2.0,
            (4, 10, 1, 3, 3): 2.5, (4, 10, 1, 4, 0): 1.5, (4, 10, 1, 4, 3): 1.5, (4, 10, 2, 0, 0): 2.5,
            (4, 10, 2, 0, 1): 2.5, (4, 10, 2, 0, 2): 2.5, (4, 10, 2, 0, 3): 1.5, (4, 10, 2, 1, 0): 1.5,
            (4, 10, 2, 1, 3): 1.5, (4, 10, 2, 2, 0): 2.5, (4, 10, 2, 2, 1): 2.5, (4, 10, 2, 3, 0): 2.0,
            (4, 10, 2, 3, 3): 2.5, (4, 10, 2, 4, 1): 2.0, (4, 10, 2, 4, 3): 1.5, (4, 10, 3, 0, 1): 1.5,
            (4, 10, 3, 0, 2): 2.0, (4, 10, 3, 0, 3): 1.5, (4, 10, 3, 1, 3): 1.5, (4, 10, 3, 2, 3): 1.5,
            (4, 10, 3, 3, 3): 1.5, (4, 10, 3, 4, 0): 1.5, (4, 10, 3, 4, 1): 2.5, (4, 10, 3, 4, 3): 1.5,
            (4, 10, 4, 0, 1): 2.5, (4, 10, 4, 0, 2): 2.5, (4, 10, 4, 1, 1): 2.0, (4, 10, 4, 1, 2): 1.5,
            (4, 10, 4, 1, 3): 2.0, (4, 10, 4, 2, 2): 2.0, (4, 10, 4, 2, 3): 1.5, (4, 10, 4, 3, 0): 2.5,
            (4, 10, 4, 3, 3): 2.0, (4, 10, 4, 4, 3): 1.5, (4, 10, 5, 1, 0): 2.0, (4, 10, 5, 1, 1): 2.5,
            (4, 10, 5, 1, 3): 2.0, (4, 11, 1, 0, 3): 1.5, (4, 11, 1, 1, 0): 2.0, (4, 11, 1, 1, 3): 1.5,
            (4, 11, 1, 2, 0): 1.5, (4, 11, 1, 2, 1): 2.0, (4, 11, 1, 2, 2): 2.5, (4, 11, 1, 2, 3): 2.0,
            (4, 11, 1, 3, 1): 2.5, (4, 11, 1, 3, 3): 1.5, (4, 11, 2, 0, 3): 1.5, (4, 11, 2, 1, 3): 2.0,
            (4, 11, 2, 2, 1): 1.5, (4, 11, 2, 2, 3): 2.0, (4, 11, 2, 3, 2): 2.5, (4, 11, 2, 4, 0): 2.5,
            (4, 11, 2, 4, 1): 2.0, (4, 11, 2, 4, 3): 1.5, (4, 11, 3, 0, 1): 2.5, (4, 11, 3, 0, 2): 2.5,
            (4, 11, 3, 0, 3): 1.5, (4, 11, 3, 1, 0): 1.5, (4, 11, 3, 1, 1): 2.5, (4, 11, 3, 1, 3): 2.5,
            (4, 11, 3, 2, 0): 2.5, (4, 11, 3, 2, 1): 2.5, (4, 11, 3, 2, 2): 2.5, (4, 11, 3, 2, 3): 1.5,
            (4, 11, 3, 3, 2): 2.5, (4, 11, 3, 3, 3): 1.5, (4, 11, 3, 4, 1): 1.5, (4, 11, 3, 4, 2): 2.5,
            (4, 11, 4, 0, 0): 2.0, (4, 11, 4, 0, 1): 2.5, (4, 11, 4, 0, 2): 2.5, (4, 11, 4, 1, 0): 2.5,
            (4, 11, 4, 1, 2): 1.5, (4, 11, 4, 1, 3): 1.5, (4, 11, 4, 2, 1): 2.5, (4, 11, 4, 3, 0): 1.5,
            (4, 11, 4, 4, 0): 2.0, (4, 11, 4, 4, 2): 1.5, (4, 11, 5, 3, 2): 2.0, (4, 11, 5, 4, 0): 2.0,
            (4, 12, 1, 0, 1): 2.0, (4, 12, 1, 0, 3): 1.5, (4, 12, 1, 1, 1): 1.5, (4, 12, 1, 1, 2): 2.5,
            (4, 12, 1, 1, 3): 1.5, (4, 12, 1, 2, 3): 1.5, (4, 12, 1, 3, 0): 2.5, (4, 12, 1, 3, 1): 2.5,
            (4, 12, 1, 3, 2): 2.0, (4, 12, 1, 3, 3): 2.0, (4, 12, 1, 4, 0): 2.0, (4, 12, 1, 4, 1): 2.5,
            (4, 12, 1, 4, 3): 1.5, (4, 12, 2, 0, 1): 2.0, (4, 12, 2, 0, 3): 1.5, (4, 12, 2, 1, 0): 2.5,
            (4, 12, 2, 1, 1): 2.0, (4, 12, 2, 2, 0): 2.0, (4, 12, 2, 2, 3): 1.5, (4, 12, 2, 3, 2): 2.0,
            (4, 12, 2, 3, 3): 1.5, (4, 12, 2, 4, 1): 1.5, (4, 12, 2, 4, 3): 1.5, (4, 12, 3, 0, 0): 2.0,
            (4, 12, 3, 0, 1): 2.0, (4, 12, 3, 0, 3): 1.5, (4, 12, 3, 1, 0): 2.0, (4, 12, 3, 1, 2): 1.5,
            (4, 12, 3, 1, 3): 1.5, (4, 12, 3, 2, 0): 2.0, (4, 12, 3, 3, 1): 1.5, (4, 12, 3, 3, 3): 1.5,
            (4, 12, 3, 4, 0): 2.0, (4, 12, 3, 4, 2): 1.5, (4, 12, 3, 4, 3): 2.0, (4, 12, 4, 0, 1): 1.5,
            (4, 12, 4, 1, 0): 2.0, (4, 12, 4, 1, 1): 1.5, (4, 12, 4, 1, 2): 1.5, (4, 12, 4, 2, 1): 2.5,
            (4, 12, 4, 2, 2): 1.5, (4, 12, 4, 4, 1): 2.5, (4, 12, 5, 0, 1): 1.5, (4, 12, 5, 0, 2): 1.5,
            (4, 12, 5, 1, 0): 2.0, (4, 12, 5, 1, 2): 2.5, (4, 12, 5, 4, 1): 1.5
        }

    def get_week_of_month(self, dt):
        """Calculates week of month (1-5) based on day of month."""
        return (dt.day - 1) // 7 + 1

    def get_session_id(self, dt):
        """Maps current hour to Session ID (0=AM, 1=Mid, 2=PM, 3=Close)."""
        # Times are expected in Eastern Time (Bot uses NY_TZ)
        h = dt.hour
        if 9 <= h < 11: return 0
        if 11 <= h < 13: return 1
        if 13 <= h < 15: return 2
        if 15 <= h < 16: return 3
        return None

    def on_bar(self, es_df, vix_df):
        """
        Runs the VIX Mean Reversion logic.
        Requires synchronized ES and VIX dataframes.
        """
        if vix_df.empty or len(vix_df) < 21:
            return None

        # 1. Determine Current Segment
        current_time = vix_df.index[-1]
        quarter = (current_time.month - 1) // 3 + 1
        month = current_time.month
        week = self.get_week_of_month(current_time)
        day_of_week = current_time.weekday() # 0=Mon, 4=Fri
        session_id = self.get_session_id(current_time)

        if session_id is None:
            return None

        # 2. Lookup Z-Score
        segment_key = (quarter, month, week, day_of_week, session_id)
        z_score = self.micro_segments.get(segment_key)

        if z_score is None:
            return None # No valid strategy for this micro-segment

        # 3. Calculate Indicators (VIX Bollinger Bands)
        # We need the last 20 bars relative to current time
        # VIX data might be slightly offset, ensure we align by index if needed
        # Assuming vix_df is 1-minute data resampled or raw

        # Calculate only for the tail to save time
        closes = vix_df['close'].values # Assuming client normalizes to 'close'
        if len(closes) < 21: return None

        # Slicing last 21 points for calculation
        relevant_closes = closes[-21:]

        # Rolling stats for the *previous* bar (index -2) and *current* bar (index -1)
        # We need the rolling window ending at -2 and -1.

        # To get rolling(20) for index -1 (current), we need -20 to -1.
        sma_curr = np.mean(relevant_closes[-20:])
        std_curr = np.std(relevant_closes[-20:], ddof=1) # Pandas default ddof=1
        ub_curr = sma_curr + (z_score * std_curr)

        # To get rolling(20) for index -2 (previous), we need -21 to -2.
        sma_prev = np.mean(relevant_closes[-21:-1])
        std_prev = np.std(relevant_closes[-21:-1], ddof=1)
        ub_prev = sma_prev + (z_score * std_prev)

        vi_curr = relevant_closes[-1]
        vi_prev = relevant_closes[-2]

        # 4. Generate Signal (VIX Crosses Below Upper Band)
        # Condition: Previous VIX > Previous Band AND Current VIX < Current Band
        if (vi_prev > ub_prev) and (vi_curr < ub_curr):
            # 5. Return Signal
            # Strategy defines: Stop = 4.0, Target = 6.0
            # VIX Mean Reversion (VIX dropping) -> Bullish ES -> LONG
            return {
                'strategy': self.strategy_name,
                'side': 'LONG',
                'sl_dist': 4.0,
                'tp_dist': 6.0,
                'size': 5, # Standard size, adjustable by vol filter
                'reason': f"VIX Reversion (Z={z_score}) Q{quarter} M{month} W{week} D{day_of_week} S{session_id}"
            }

        return None
